<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ×—× ×•×ª - ××•×¨×”</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            padding: 30px; 
            background-color: #f4f6f9; 
            direction: rtl; 
            color: #333;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .header h2 { 
            color: #17a2b8; 
            margin: 0;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #e9ecef;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tab.active {
            background-color: #17a2b8;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
            margin-bottom: 20px;
        }
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn { 
            border: none; 
            padding: 10px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { 
            background-color: #28a745; 
            color: white;
        }
        .btn-primary:hover { 
            background-color: #218838; 
        }
        .btn-danger { 
            background-color: #dc3545; 
            color: white;
        }
        .btn-danger:hover { 
            background-color: #c82333; 
        }
        .btn-success { 
            background-color: #28a745; 
            color: white;
        }
        .btn-reject { 
            background-color: #ffc107; 
            color: #333;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .product-item, .purchase-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-item:last-child, .purchase-item:last-child {
            border-bottom: none;
        }
        .product-info, .purchase-info {
            flex: 1;
        }
        .product-name, .purchase-product {
            font-weight: bold;
            font-size: 1.1em;
        }
        .product-price, .purchase-price {
            color: #28a745;
            font-weight: bold;
        }
        .stock-info {
            font-size: 0.95em;
            margin-top: 5px;
        }
        .stock-low {
            color: #dc3545;
            font-weight: bold;
        }
        .stock-out {
            color: #dc3545;
            font-weight: bold;
            background-color: #f8d7da;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .stock-ok {
            color: #28a745;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-pending {
            background-color: #ffc107;
            color: #333;
        }
        .status-approved {
            background-color: #28a745;
            color: white;
        }
        .status-rejected {
            background-color: #dc3545;
            color: white;
        }
        .notification-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.85em;
            margin-right: 5px;
        }
        .message {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
        .msg-success {
            background-color: #d4edda;
            color: #155724;
        }
        .msg-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .image-preview-box {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
        .btn-save {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>× ×™×”×•×œ ×—× ×•×ª ×”×›×™×ª×” ğŸ›’</h2>
        <div>
            <button onclick="window.location.href='admin.html'" class="btn" style="background-color: #6c757d; color: white;">×—×–×¨×” ×œ× ×™×”×•×œ</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('products')">××•×¦×¨×™×</button>
        <button class="tab" onclick="showTab('pending')">
            ×‘×§×©×•×ª ×××ª×™× ×•×ª
            <span id="pendingCount" class="notification-badge" style="display: none;">0</span>
        </button>
        <button class="tab" onclick="showTab('history')">×”×™×¡×˜×•×¨×™×™×ª ×§× ×™×•×ª</button>
    </div>

    <!-- ×˜××‘ ××•×¦×¨×™× -->
    <div id="productsTab" class="tab-content active">
        <div class="card">
            <h3>â• ×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©</h3>
            <input type="text" id="productName" placeholder="×©× ×”××•×¦×¨">
            <input type="number" id="productPrice" placeholder="××—×™×¨ ×‘× ×§×•×“×•×ª">
            <input type="number" id="productStock" placeholder="×›××•×ª ×‘××œ××™" value="0">
            <textarea id="productDescription" placeholder="×ª×™××•×¨ ×”××•×¦×¨ (××•×¤×¦×™×•× ×œ×™)"></textarea>
            
            <!-- ×”×¢×œ××ª ×ª××•× ×” -->
            <div class="image-preview-box">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">ğŸ“· ×ª××•× ×ª ××•×¦×¨ (××•×¤×¦×™×•× ×œ×™):</label>
                <input type="file" id="productImage" accept="image/*" style="margin-bottom: 10px;">
                <div id="imagePreview" style="display: none; margin-top: 15px;">
                    <img id="previewImg" style="max-width: 250px; max-height: 250px; border-radius: 8px; border: 2px solid #17a2b8;">
                    <br>
                    <button class="btn btn-danger" onclick="clearImage()" style="margin-top: 10px;">×”×¡×¨ ×ª××•× ×”</button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addProduct()">×”×•×¡×£ ××•×¦×¨</button>
            <div id="productMessage"></div>
        </div>

        <div class="card">
            <h3>×¨×©×™××ª ××•×¦×¨×™× ×‘×—× ×•×ª</h3>
            <div id="productsList"></div>
        </div>
    </div>

    <!-- ×˜××‘ ×‘×§×©×•×ª ×××ª×™× ×•×ª -->
    <div id="pendingTab" class="tab-content">
        <div class="card">
            <h3>×‘×§×©×•×ª ×§× ×™×” ×××ª×™× ×•×ª ×œ××™×©×•×¨</h3>
            <div id="pendingList"></div>
        </div>
    </div>

    <!-- ×˜××‘ ×”×™×¡×˜×•×¨×™×” -->
    <div id="historyTab" class="tab-content">
        <div class="card">
            <h3>×”×™×¡×˜×•×¨×™×™×ª ×›×œ ×”×§× ×™×•×ª</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- ××•×“×œ ×œ×¢×“×›×•×Ÿ ××œ××™ -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">×¢×“×›×•×Ÿ ××œ××™</div>
            <div id="stockProductName" style="margin-bottom: 15px; color: #666;"></div>
            <div id="currentStock" style="margin-bottom: 15px; font-weight: bold;"></div>
            <input type="number" id="newStock" placeholder="××œ××™ ×—×“×©" min="0">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeStockModal()">×‘×™×˜×•×œ</button>
                <button class="btn-save" onclick="saveStock()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script>
        const classId = localStorage.getItem('classId');
        const className = localStorage.getItem('className');
        const isSuperadmin = localStorage.getItem('superadminMode') === 'true';
        const isTeacher = localStorage.getItem('teacherAuth') === 'true';

        if (!classId || (!isSuperadmin && !isTeacher)) {
            window.location.href = 'index.html';
        }

        let currentEditProductId = null;

        // ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×ª××•× ×”
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('productImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('previewImg').src = event.target.result;
                        document.getElementById('imagePreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function clearImage() {
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function showTab(tabName) {
            // ×”×¡×ª×¨×ª ×›×œ ×”×˜××‘×™×
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // ×”×¦×’×ª ×”×˜××‘ ×”× ×‘×—×¨
            if (tabName === 'products') {
                document.getElementById('productsTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
                loadProducts();
            } else if (tabName === 'pending') {
                document.getElementById('pendingTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
                loadPendingPurchases();
            } else if (tabName === 'history') {
                document.getElementById('historyTab').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
                loadPurchaseHistory();
            }
        }

        function showMessage(elementId, message, isSuccess) {
            const el = document.getElementById(elementId);
            el.innerHTML = message;
            el.className = 'message ' + (isSuccess ? 'msg-success' : 'msg-error');
            setTimeout(() => { el.innerHTML = ''; el.className = ''; }, 3000);
        }

        async function addProduct() {
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const stock = document.getElementById('productStock').value;
            const description = document.getElementById('productDescription').value;
            const imageFile = document.getElementById('productImage').files[0];

            if (!name || !price) {
                showMessage('productMessage', '× × ×œ××œ× ×©× ×•××—×™×¨', false);
                return;
            }

            let imageBase64 = null;
            
            // ×”××¨×ª ×”×ª××•× ×” ×œ-Base64 ×× ×§×™×™××ª
            if (imageFile) {
                try {
                    imageBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageFile);
                    });
                } catch (error) {
                    console.error('×©×’×™××” ×‘×§×¨×™××ª ×”×ª××•× ×”:', error);
                    showMessage('productMessage', '×©×’×™××” ×‘×§×¨×™××ª ×”×ª××•× ×”', false);
                    return;
                }
            }

            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name, 
                    price, 
                    stock: parseInt(stock) || 0,
                    description,
                    image: imageBase64,
                    classId
                })
            });
            const data = await res.json();

            if (data.success) {
                showMessage('productMessage', data.message, true);
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productStock').value = '0';
                document.getElementById('productDescription').value = '';
                clearImage();
                loadProducts();
            } else {
                showMessage('productMessage', data.message, false);
            }
        }

        async function loadProducts() {
            const res = await fetch(`/api/products/${classId}`);
            const products = await res.json();
            const list = document.getElementById('productsList');

            if (products.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d;">××™×Ÿ ×¢×“×™×™×Ÿ ××•×¦×¨×™× ×‘×—× ×•×ª</p>';
                return;
            }

            list.innerHTML = '';
            products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'product-item';
                
                let imageHTML = '';
                if (p.image) {
                    imageHTML = `<img src="${p.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-left: 15px;">`;
                }
                
                let stockClass = 'stock-ok';
                let stockText = `××œ××™: ${p.stock} ×™×—×™×“×•×ª`;
                if (p.stock === 0) {
                    stockClass = 'stock-out';
                    stockText = 'âŒ ××–×œ ××”××œ××™';
                } else if (p.stock <= 5) {
                    stockClass = 'stock-low';
                    stockText = `âš ï¸ ××œ××™ × ××•×š: ${p.stock} ×™×—×™×“×•×ª`;
                }
                
                div.innerHTML = `
                    ${imageHTML}
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div>${p.description || ''}</div>
                        <div class="product-price">${p.price} × ×§×•×“×•×ª</div>
                        <div class="stock-info ${stockClass}">${stockText}</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn btn-info" onclick="openStockModal('${p._id}', '${p.name}', ${p.stock})">ğŸ“¦ ×¢×“×›×Ÿ ××œ××™</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${p._id}')">××—×§</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function openStockModal(productId, productName, currentStock) {
            currentEditProductId = productId;
            document.getElementById('stockProductName').textContent = `××•×¦×¨: ${productName}`;
            document.getElementById('currentStock').textContent = `××œ××™ × ×•×›×—×™: ${currentStock} ×™×—×™×“×•×ª`;
            document.getElementById('newStock').value = currentStock;
            document.getElementById('stockModal').style.display = 'block';
        }

        function closeStockModal() {
            document.getElementById('stockModal').style.display = 'none';
            currentEditProductId = null;
        }

        async function saveStock() {
            const newStock = document.getElementById('newStock').value;
            
            if (newStock === '' || newStock < 0) {
                alert('× × ×œ×”×–×™×Ÿ ××œ××™ ×—×•×§×™');
                return;
            }

            const res = await fetch(`/api/products/${currentEditProductId}/stock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock: parseInt(newStock) })
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                closeStockModal();
                loadProducts();
            } else {
                alert('×©×’×™××”: ' + data.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××•×¦×¨ ×–×”?')) return;

            const res = await fetch(`/api/products/${id}`, {
                method: 'DELETE'
            });
            const data = await res.json();

            if (data.success) {
                loadProducts();
            } else {
                alert(data.message);
            }
        }

        async function loadPendingPurchases() {
            const res = await fetch(`/api/purchases/${classId}`);
            const purchases = await res.json();
            const pending = purchases.filter(p => p.status === 'pending');
            
            // ×¢×“×›×•×Ÿ ×ª×’ ×”×ª×¨××”
            const badge = document.getElementById('pendingCount');
            if (pending.length > 0) {
                badge.textContent = pending.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            const list = document.getElementById('pendingList');

            if (pending.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d;">××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª</p>';
                return;
            }

            list.innerHTML = '';
            for (const p of pending) {
                // ×‘×“×™×§×ª ××œ××™ ×¢×‘×•×¨ ×›×œ ×§× ×™×”
                const productRes = await fetch(`/api/products/${classId}`);
                const products = await productRes.json();
                const product = products.find(prod => prod._id === p.productId);
                
                const div = document.createElement('div');
                div.className = 'purchase-item';
                
                let stockWarning = '';
                if (product && product.stock <= 0) {
                    stockWarning = '<div style="color: #dc3545; font-weight: bold; margin-top: 5px;">âš ï¸ ×”××•×¦×¨ ××–×œ ××”××œ××™!</div>';
                }
                
                div.innerHTML = `
                    <div class="purchase-info">
                        <div class="purchase-product">${p.productName}</div>
                        <div>×ª×œ××™×“: ${p.studentName} (${p.studentId})</div>
                        <div class="purchase-price">××—×™×¨: ${p.price} × ×§×•×“×•×ª</div>
                        <div style="font-size: 0.9em; color: #6c757d;">
                            ×ª××¨×™×š: ${new Date(p.createdAt).toLocaleDateString('he-IL')}
                        </div>
                        ${stockWarning}
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="approvePurchase('${p._id}', true)" ${product && product.stock <= 0 ? 'disabled' : ''}>âœ“ ××©×¨</button>
                        <button class="btn btn-reject" onclick="approvePurchase('${p._id}', false)">âœ— ×“×—×”</button>
                    </div>
                `;
                list.appendChild(div);
            }
        }

        async function approvePurchase(id, approve) {
            const res = await fetch(`/api/purchases/${id}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ approve })
            });
            const data = await res.json();

            if (data.success) {
                alert(data.message);
                loadPendingPurchases();
                loadProducts(); // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××•×¦×¨×™× ×œ×¢×“×›×•×Ÿ ×”××œ××™
            } else {
                alert(data.message);
            }
        }

        async function loadPurchaseHistory() {
            const res = await fetch(`/api/purchases/${classId}`);
            const purchases = await res.json();
            const list = document.getElementById('historyList');

            if (purchases.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d;">××™×Ÿ ×¢×“×™×™×Ÿ ×§× ×™×•×ª</p>';
                return;
            }

            list.innerHTML = '';
            purchases.forEach(p => {
                const div = document.createElement('div');
                div.className = 'purchase-item';
                
                let statusBadge = '';
                if (p.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">×××ª×™×Ÿ</span>';
                } else if (p.status === 'approved') {
                    statusBadge = '<span class="status-badge status-approved">××•×©×¨</span>';
                } else if (p.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected">× ×“×—×”</span>';
                }

                div.innerHTML = `
                    <div class="purchase-info">
                        <div class="purchase-product">${p.productName} ${statusBadge}</div>
                        <div>×ª×œ××™×“: ${p.studentName} (${p.studentId})</div>
                        <div class="purchase-price">××—×™×¨: ${p.price} × ×§×•×“×•×ª</div>
                        <div style="font-size: 0.9em; color: #6c757d;">
                            ×ª××¨×™×š ×‘×§×©×”: ${new Date(p.createdAt).toLocaleDateString('he-IL')}
                            ${p.approvedAt ? ' | ××•×©×¨ ×‘: ' + new Date(p.approvedAt).toLocaleDateString('he-IL') : ''}
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª + ×¨×¢× ×•×Ÿ ×ª×§×•×¤×ª×™ ×©×œ ×”×ª×¨××•×ª
        loadProducts();
        loadPendingPurchases();
        setInterval(loadPendingPurchases, 30000); // ×¨×¢× ×•×Ÿ ×›×œ 30 ×©× ×™×•×ª
    </script>
</body>
</html>
